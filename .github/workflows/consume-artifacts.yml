name: 'Consume Artifacts from Producers'

on:
  workflow_run:
    workflows:
      - 'quality-monitor-dependency-check.yml'
      - 'other-producer.yml'
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  fetch-artifacts:
    name: Fetch artifacts from producer workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Ensure jq and unzip installed
        run: |
          sudo apt-get update && sudo apt-get install -y jq unzip

      - name: Prepare environment
        env:
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "HEAD_SHA=$HEAD_SHA"
          echo "REPO=$REPO"

      - name: Fetch artifacts from other workflows
        env:
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OTHER_WORKFLOWS: "quality-monitor-dependency-check.yml,other-producer.yml"
          ARTIFACT_NAMES: "dependency-report,other-report"
          RETRIES: 30
          SLEEP_SEC: 10
        run: |
          chmod +x ./.github/scripts/fetch-artifacts.sh
          ./.github/scripts/fetch-artifacts.sh

      - name: List downloaded artifacts
        run: |
          ls -la artifacts || true

      - name: Continue with consumer steps
        run: |
          echo "Now you can consume files in ./artifacts/"

